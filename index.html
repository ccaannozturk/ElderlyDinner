<script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your Firebase configuration object
    const firebaseConfig = {
        apiKey: "AIzaSyA8aIPnf06TevhDZM0g0YVKz-pz9pwUbsQ",
        authDomain: "rsvp-8aeb4.firebaseapp.com",
        projectId: "rsvp-8aeb4",
        storageBucket: "rsvp-8aeb4.firebasestorage.app",
        messagingSenderId: "186833662480",
        appId: "1:186833662480:web:2465ce4c746a3e8cf4d095"
    };

    let app, db, auth, userId;
    let isAdmin = false; // Flag to track admin status

    // Function to show a custom message box
    function showMessageBox(message) {
        const messageBox = document.getElementById('messageBox');
        const messageBoxContent = document.getElementById('messageBoxContent');
        messageBoxContent.textContent = message;
        messageBox.style.display = 'block';
    }

    // Close message box
    document.getElementById('messageBoxClose').addEventListener('click', () => {
        document.getElementById('messageBox').style.display = 'none';
    });

    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Firebase
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authenticate user anonymously
            await signInAnonymously(auth);

            // Set user ID after authentication
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated:", userId);
                    loadRsvps(); // Load RSVPs once authenticated
                } else {
                    console.log("No user is signed in.");
                }
            });

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showMessageBox("Failed to initialize the app. Please try again later.");
        }

        // Tab switching logic
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const targetContent = document.getElementById(`${button.dataset.tab}-content`);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            });
        });

        // RSVP Logic
        const rsvpNameInput = document.getElementById('rsvpNameInput');
        const rsvpSubmitButton = document.getElementById('rsvpSubmitButton');
        const attendeesList = document.getElementById('attendeesList');
        const rsvpLoading = document.getElementById('rsvpLoading');

        // Function to add an RSVP
        rsvpSubmitButton.addEventListener('click', async () => {
            const name = rsvpNameInput.value.trim();
            if (name === "") {
                showMessageBox("Please enter your name to RSVP.");
                return;
            }

            if (!db || !userId) {
                showMessageBox("App not ready. Please wait or refresh.");
                return;
            }

            // Activate admin mode without adding "admin" to the list
            if (name.toLowerCase() === 'admin') {
                isAdmin = true;
                showMessageBox("Admin mode activated. You can now see remove buttons.");
                loadRsvps(); // Reload the list to show buttons
                rsvpNameInput.value = ''; // Clear input
                return; 
            }

            try {
                await addDoc(collection(db, `artifacts/${firebaseConfig.appId}/public/data/rsvps`), {
                    name: name,
                    timestamp: new Date(),
                });
                rsvpNameInput.value = '';
                showMessageBox("Thank you for your RSVP!");
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessageBox("Failed to add your RSVP. Please try again.");
            }
        });

        // Function to delete an RSVP
        async function deleteRsvp(docId) {
            if (!db || !isAdmin) {
                showMessageBox("You do not have permission to remove RSVPs.");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.appId}/public/data/rsvps`, docId));
                showMessageBox("RSVP removed successfully.");
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessageBox("Failed to remove RSVP. Check console for details.");
            }
        }

        // Function to load RSVPs in real-time
        function loadRsvps() {
            if (!db) return;

            const rsvpsCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/rsvps`);
            const q = query(rsvpsCollectionRef, orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                attendeesList.innerHTML = '';
                if (snapshot.empty) {
                    attendeesList.innerHTML = '<li class="text-gray-500">No attendees yet. Be the first to RSVP!</li>';
                } else {
                    snapshot.forEach((doc) => {
                        const rsvp = doc.data();
                        const listItem = document.createElement('li');
                        listItem.className = 'attendee-item';
                        listItem.textContent = rsvp.name;

                        if (isAdmin) {
                            const removeButton = document.createElement('button');
                            removeButton.textContent = 'Remove';
                            removeButton.className = 'remove-btn';
                            removeButton.addEventListener('click', () => deleteRsvp(doc.id));
                            listItem.appendChild(removeButton);
                        }
                        attendeesList.appendChild(listItem);
                    });
                }
                rsvpLoading.style.display = 'none';
            }, (error) => {
                console.error("Error fetching RSVPs:", error);
                attendeesList.innerHTML = '<li class="text-red-500">Failed to load attendees.</li>';
                rsvpLoading.style.display = 'none';
            });
        }
    });
</script>
